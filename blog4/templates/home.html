
<!DOCTYPE html>
<html>
<head>
	<title>Home</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <!-- <script src='https://kit.fontawesome.com/a076d05399.js'></script> -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style type="text/css">
ul{
  list-style-type: none;
  margin: 0;
  padding: 0;
  width: 170px;
  background-color: #ffffff;
  border-radius: 10px;
  text-align:center;
  font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
	font-weight: 400;
	/* padding: 20px; */
  /* position: fixed; */
  /* float: right; */
}
.bloggers {
  
  margin: 0;
  padding: 0px;
  width: 100%;
  background-color: #ffffff;
  border-radius: 10px;
  margin-right: 2px;
  margin-left: auto;
  /*: center;*/
  display: block;
  /* position: fixed; */
}

li{
  display: block;
  color: #000;
  padding: 8px 16px;
  text-decoration: none;
  cursor: pointer;
  border-bottom: 5px black;
  box-shadow: #ffffff;
  border-radius: 10px;
}

/* Change the link color on hover */
li:hover {
  background-color: #555;
  color: white;
}
body{
	/* background-image: url("/static/img/mail.png"); */
	/* background-color: #000; */
	background-image: url('/static/img/login.jpg');background-size:cover;
	background-size: cover;
	position: relative;
}
.rmail-div,#blogger_display{
	/*background-color:rgb(24, 211, 218);*/
	background-color:white;
	/*color:aqua;*/
	opacity: 0.9;
	width:60%;
	height:80%;
	border-radius: 25px;
	padding: 25px;
	/* margin-left: 5%;
	margin-top:02%; */
	 /*opacity: 0.8; */
	align: center;
	display: inline-block;
}

button{
	background-color: teal;
	border-radius : 10px;
	border-collapse: collapse;
	border: none;
	font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
	color:white;
	padding:10px;
	margin: 20px auto;
	display: block;
	cursor: pointer;
	
	
}
.star{
	font-size: 35px;
}
.spam{
	font-size:35px;
}


.highight-menu {
    background-color: #777777 !important;
    color: white !important;
}

.checked{
    color:orange;
}
.uncheck{
    color:white;
}
.subject:hover{
	cursor:pointer;
	font-weight: 800;
	font-size: 20px;
	text-shadow: 2px 2px 5px blue;
}
table{
    /* border-bottom:2px solid grey;s */
	display: block;
	margin:0 auto;
	font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
	font-weight: 400;
	text-align: center;
	empty-cells: show;
}
.rmail-div:hover{background-color: gray;color: white}
.ribbon{
	position: absolute;
	width: 100%;
}
.ribbon-6{
	width:100%;
	height:60px;
	background: skyblue;
}

/* Dropdown Button */
.dropbtn {
  background-color: #3498DB;
  color: white;
  /*margin-top: 10px;*/
  font-size: 16px;
  border: none;
  cursor: pointer;
  display: inline-block;
}

/* Dropdown button on hover & focus */
.dropbtn:hover, .dropbtn:focus {
  background-color: #2980B9;
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  margin-left: 89%;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd}

/* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
.show {display:block;}

.sendmail:hover{
	cursor:pointer;
	font-weight: 800;
	font-size: 20px;
	text-shadow: 2px 2px 5px red;
}
.fa {
  font-size: 30px;
  cursor: pointer;
  user-select: none;
}

.fa:hover {
  color: teal;
}
</style>

</head>
<body >
	<div class="wrapper" >
		<div class="conatiner">
			<div class="ribbon-6 ribbon">
				<!-- <img src="./static/img/logo-1.jpg" style="margin-left: 0;margin-right: auto;" width="132px" height="99px"> -->
				<button onclick="myFunction()" class="dropbtn" style="margin-top: 15px;margin-left: 95%;"><i class="fas fa-bars"></i></button>
  				<div id="myDropdown" class="dropdown-content">
  					<button onclick="window.location.assign('/edit_details'); return false;">Edit Details</button>
  					<button onclick="signout()" style="background:red";>Signout</button>
 				 </div>

			</div>s
		</div>
	</div>

	<div style="float: right;" height= "100%">
		<div style="margin-top: 50px;">
			<ul id="categories">
				<caption><strong>Categories</strong> </caption>

			</ul>	
		</div>
	
		<div style="margin-right:1%;">
			<table class="bloggers" id="bloggers" style="margin-top: 50px;float: right;">
					<caption><strong>Bloggers</strong></caption>
			</table>
		</div>
	</div>

	<div>
        <button onclick="compose(this)" style="margin-top:50px" >Compose New Blog</button>
	</div>
	<div style="text-align: left;margin-left: 5%;">
    <div id="rmail_disp" class="rmail">

	</div>
	</div>	

    


</body>
<script type="text/javascript">

function myFunction() {
  document.getElementById("myDropdown").classList.toggle("show");
}

// Close the dropdown menu if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {
    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}
//latest mail id
lmid=null;
time=null;
//variable used to record the lateset time
flag=0
email=localStorage.getItem("email");

function signout()
{
	localStorage.clear();
	window.location.assign('/signout');
}


function subscribeToBlog(blogger)
{	console.log("here");
	var email=localStorage.getItem("email");
	var form=document.getElementById("subscribe-form");
	// var blogger=form["blogger"].value;
	console.log("subscribeToBlog:"+blogger);
	
	var xhr=new XMLHttpRequest();
	xhr.open("POST","/subscribeToBlog/"+email+"/"+blogger,true);
	xhr.onload=function()
	{
		if(this.status==200)
		{
			console.log("subscribed");
			
		}
		else
		{
			console.log("some error");
			
		}
	}
	
	xhr.send();
	
}


function load_subscriber_info()
{	console.log("load_subscriber_info");
	var xhr=new XMLHttpRequest();
	xhr.open("GET","/get_bloggers",true);
	xhr.onload=function()
	{
		if(this.status==200)
		{	var data=JSON.parse(this.response);
			console.log(data);
			var form=document.getElementById("subscribe-form");
			var select=document.createElement("select");
			select.setAttribute("id","blogger");
			select.setAttribute("name","blogger");
			select.setAttribute("required",true);

			for(var i=0;i<data.length;i++)
			{
				var option=document.createElement("option");
				option.setAttribute("value",data[i]["email"]);
				option.innerHTML=data[i]["email"];
				select.appendChild(option);
			}
			form.appendChild(select);
			var button=document.createElement("button");
			button.innerHTML="Subscribe";
			button.onclick=subscribeToBlog;
			form.appendChild(button);

		}
		else
		{
			console.log("some error occured");
		}
	}
	xhr.send();
}


function load_categories()
{
	var xhr=new XMLHttpRequest();
	xhr.open('GET','/get_category',true);
	xhr.onload=function(){
		if(this.status==200)
		{
			data=JSON.parse(this.responseText);
			ul=document.getElementById("categories");
			for(var i=0;i<data.length;i++)
			{	
				li=document.createElement("li");
				li.innerHTML=data[i]['category'];			
				
				li.id=data[i]['category'];
				li.onclick=function()
							{	
								var url="/redirect_display_blog_category";
								localStorage.setItem("category",this.id);
				
								window.open(url);
				
							}
				ul.appendChild(li)
				
			}
			
			
		}
		else
		{
			console.log("Error in loading category");
		}
	}
	xhr.send()
}

function load_bloggers()
{
	var xhr=new XMLHttpRequest();
	xhr.open('GET','/get_bloggers',true);
	xhr.onload=function(){
		if(this.status==200)
		{	
			
			data=JSON.parse(this.responseText);
			table=document.getElementById("bloggers");
			table.width="80%";

			for(var i=0;i<data.length;i++)
			{	tr=document.createElement("tr");
				td=document.createElement("td");
				td.innerHTML=data[i]['email'].split('@')[0];
				td.id="blogger"+data[i]['email'];
				tr.appendChild(td);
				td=document.createElement("td");
				bt=document.createElement("button");
				bt.style.padding="3px";
				bt.value="Subscribe";
				bt.innerHTML="Subscribe";
				bt.id="button"+data[i]['email']
				// bt.onclick=subscribeToBlog(this.previousSibling.innerHTML);
				bt.onclick=function(){subscribeToBlog(this.parentNode.previousSibling.innerHTML);
								this.innerHTML="Subscribed";
								this.style.backgroundColor="green";
								this.onclick=unsubscribe;
					}
				td.appendChild(bt);
				tr.appendChild(td);
				
				table.appendChild(tr)
				
			}
			
			
		}
		else
		{
			console.log("Error in loading bloggers");
		}
	}
	xhr.send()
	
}	
function subscribe(){
	// console.log(this);
	subscribeToBlog(this.id.substring(6));
	this.innerHTML="Subscribed";
	this.style.backgroundColor="green";
	this.onclick=unsubscribe;

}
function unsubscribe(){
	var xhr=new XMLHttpRequest();
	// console.log("IN ALREADY");
	var email=localStorage.getItem("email");
	// console.log(this.id.substring(6));
	// console.log(email);
	d=this;
	xhr.open('POST','/unsubscribeToBlog/'+email+'/'+this.id.substring(6),true);
	xhr.onload=function(){
		if(this.status==200){
			d.innerHTML="Subscribe";
			d.style.backgroundColor="teal";
			d.onclick=function(){subscribe();}
		}
		else{
			console.log("Unable to unsubscribe");
		}

	}
	xhr.send();
}
function alreadySubscribed() {
	var xhr=new XMLHttpRequest();
	// console.log("IN ALREADY");
	var email=localStorage.getItem("email");
	// console.log(email);
	xhr.open('GET','/getSubscription/'+email,true);
	xhr.onload=function(){
		if(this.status==200){
			data=JSON.parse(this.responseText);
			// console.log(data);
			for(var i=0;i<data.length;i++){
				d=document.getElementById("button"+data[i]["blogger_email"]);
				// console.log(data[i]["blogger_email"]);
				d.innerHTML="Subscribed";
				d.style.backgroundColor="green";
				d.onclick=unsubscribe;
			}
		}

	}
	xhr.send();
	
}
function getlatestdata()
{
	var xhr=new XMLHttpRequest();
	xhr.open("GET","/getData/"+email+"/latest",true);

	xhr.onload=function()
	{
		if(this.status==200)
		{
			data=JSON.parse(this.responseText);
			lmid=data[0]["id"];
			//console.log(lmid)
			console.log(data.length+" new mails received/modified");
			var rmail_disp=document.getElementById("rmail_disp");
			rmail_disp.innerHTML="";
			if(data.length>0)
			{
				for(var i=data.length-1;i>=0;i--)
				{
					var division=document.createElement("div");
					division.classList="rmail-div";
					var mail=data[i];

					var table=document.createElement("table");
					table.id=mail["id"];
					table.class="table"+mail["id"];
				
                    
						tr=document.createElement("tr");
						
							td=document.createElement("td");
                            td.width="16%";
							td.id=mail["id"];
							td.innerHTML="<b>Posted By:</b><br>"+mail["send_email"].split("@")[0];
							// td.classList="sendmail";
							// td.onclick=function ()
							// {	var url="/redirect_display_mail";
							// 	localStorage.setItem("mid",this.id);
							// 	// open(url,"","height=600,width=600,scrollbars=yes");
							// 	window.open(url);
							// 	// window.location.assign(url);
							// }
							tr.appendChild(td);

							td=document.createElement("td");
							td.width="16%";
							td.innerHTML="<b>Subject:</b><br>"+mail["subject"];
							td.classList="subject";
							td.onclick=function ()
							{	var url="/redirect_display_mail";
								localStorage.setItem("mid",this.previousSibling.id);
								// open(url,"","height=600,width=600,scrollbars=yes");
								window.open(url);
								// window.location.assign(url);
							}
							// tr.appendChild(td);
							tr.appendChild(td);
							

							td=document.createElement("td");
							td.width="16%";
							td.innerHTML="<b>Posted on:</b><br>"+mail["date"];
							if(flag==0)
							{
								lmid=mail["id"];
								flag=1;
							}
							tr.appendChild(td);

							td=document.createElement("button");
							td.width="16%";
							td.innerHTML='<i id="like" onclick="myFunction(this)" class="fa fa-thumbs-up"></i>'+mail["likes"];
							td.id=mail["id"];
							td.onclick=function()
							{	var previous=this;
								var xhr=new XMLHttpRequest();
								xhr.open("GET","/like/"+this.id+"/"+email,true);
								xhr.onload=function()
								{
									if(this.status==200)
									{	
										console.log("liked");
										previous.innerHTML=parseInt(previous.innerHTML)+1+" Likes";
										previous.onclick=function(){};
									}
									else{
										console.log("like failed");
										previous.onclick=function(){};
										
									}
								}
								xhr.send();
								
							}
							tr.appendChild(td);

							td=document.createElement("td");
							bt=document.createElement("button");
							td.width="16%";
							bt.innerHTML='<i id="dislike" onclick="myFunction2(this)" class="fa fa-thumbs-down"></i>' + mail['dislikes'];
							bt.id=mail["id"];
							bt.onclick=function()
							{	var previous=this;
								var xhr=new XMLHttpRequest();
								xhr.open("GET","/dislike/"+this.id+"/"+email,true);
								xhr.onload=function()
								{
									if(this.status==200)
									{	
										console.log("disliked");
										previous.innerHTML=parseInt(previous.innerHTML)+1+"Dislikes";
										previous.onclick=function(){};
									}
									else{
										console.log("dislike failed");
										previous.onclick=function(){};
									}
								}
								xhr.send();
								
							}
							td.appendChild(bt);
							tr.appendChild(td);

							
							
								var button=document.createElement("button");
								button.id=mail["id"];
								button.innerHTML="<i class='fas fa-pen-nib' style='font-size:28px'></i>";
								button.onclick=function(){
									localStorage.setItem("bid",this.id);
									open("/edit_blog","", "height=600,width=600,scrollbars=yes");
								}
								
								
								
							
							td=document.createElement("td");
							td.width="16%";
							if(email.trim()!=mail["send_email"].trim())
							{
								td.onclick=null;
								button.style.display="none";
								// button.style.backgroundColor="white";
							}
							td.appendChild(button);
							tr.appendChild(button);


						table.appendChild(tr);
					//checking whether table already exists  or nto
					

					var etable=document.querySelector(".table"+mail["id"]);
					if(etable!=null)
					{	//reoving button element
						rmail_disp.removeChild(etable);
					}
						division.appendChild(table);
						// rmail_disp.insertBefore(division);
						rmail_disp.insertBefore(division,rmail_disp.childNodes[0]);
					
				}
			}
					

		}
		
		clearTimeout(time);
		time=setTimeout(getlatestdata,5000);
		

	}
	xhr.send();
	
}
function compose(){
            open("/compose","", "height=600,width=600,scrollbars=yes");
        }
document.body.onload=function(){
	//every blogger/ user should be subscribed to himself
	var xhr=new XMLHttpRequest();
	xhr.open("POST","/subscribeToBlog/"+email+"/"+email,true);
	xhr.onload=function()
	{
		if(this.status==200)
		{
			console.log("subscribed");
		}
		else
		{
			console.log("some error");
		}
	}
	xhr.send();
	// load_subscriber_info();
	load_categories();
	load_bloggers();
	alreadySubscribed();
	getlatestdata();
	
}

</script>



</html>